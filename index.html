<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Registration</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; background:#fafafa; }
    .card { background:#fff; border-radius:16px; padding:24px; max-width:560px; margin:auto; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
    h2 { margin-top:0; }
    .page { display:none; }
    .active { display:block; }
    label { font-weight:600; margin-top:12px; display:block; }
    input[type="email"], input[type="password"], input[type="file"] {
      display:block; margin:8px 0 16px; padding:10px; width:100%; box-sizing:border-box;
      border:1px solid #ddd; border-radius:10px;
    }
    button { padding:12px 18px; border:0; border-radius:12px; cursor:pointer; }
    .primary { background:#2563eb; color:#fff; }
    .row { display:flex; gap:12px; }
    small.note { font-weight:normal; color:#666; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Student Registration</h2>

    <!--
      Using Formspree endpoint provided by you:
      https://formspree.io/f/xzzypezk

      This is ONE <form> wrapping both pages. We just hide/show sections with JS.
      When you press Submit, the browser posts the form data (including the file) directly to Formspree.
    -->
    <form id="studentForm" action="https://formspree.io/f/xzzypezk" method="POST" enctype="multipart/form-data" accept-charset="UTF-8">
      <!-- Page 1 -->
      <div id="page1" class="page active">
        <label>Email:</label>
        <input type="email" id="email" name="email" required />

        <label>Password: <small class="note">(Use a difficult password)</small></label>
        <input type="password" id="password" name="password" required />

        <label>Confirm Password:</label>
        <input type="password" id="confirmPassword" required />

        <button class="primary" type="button" onclick="goToPage2()">Next</button>
      </div>

      <!-- Page 2 -->
      <div id="page2" class="page">
        <label>Upload Your CV (PDF/DOC):</label>
        <input type="file" id="cvFile" name="cv" accept="application/pdf,.doc,.docx" />

        <div class="row">
          <button type="button" onclick="goBack()">Back</button>
          <button class="primary" type="submit">Submit</button>
        </div>
      </div>

      <!-- Optional metadata fields for Formspree -->
      <input type="hidden" name="_subject" value="New Student Registration" />
      <input type="hidden" name="_language" value="en" />
      <!-- To request JSON response (useful if you ever switch to fetch):
      <input type="hidden" name="_format" value="json" /> -->
    </form>
  </div>

  <script>
    function goToPage2() {
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value;
      const confirm = document.getElementById('confirmPassword').value;

      if (!email || !pass || !confirm) { alert('Please fill all fields.'); return; }
      if (pass !== confirm) { alert('Passwords do not match!'); return; }

      // Move to page 2
      document.getElementById('page1').classList.remove('active');
      document.getElementById('page2').classList.add('active');
    }

    function goBack() {
      document.getElementById('page2').classList.remove('active');
      document.getElementById('page1').classList.add('active');
    }

    // Improved submit handler that shows clear success/error messages
    const form = document.getElementById('studentForm');
    form.addEventListener('submit', async (e) => {
      // Let us handle it via fetch so we can show a message instead of a redirect
      e.preventDefault();
      const endpoint = form.action;
      const fd = new FormData(form);

      // Formspree returns nice JSON if we ask for it
      const send = async (bodyFd) => fetch(endpoint, {
        method: 'POST',
        headers: { 'Accept': 'application/json' },
        body: bodyFd
      });

      try {
        let res = await send(fd);
        if (!res.ok) {
          // If file uploads are blocked on your Formspree plan, try again without the CV
          const cv = document.getElementById('cvFile').files[0];
          if (cv) {
            const retry = confirm('Upload failed (likely due to file attachment limits). Submit without CV?');
            if (retry) {
              const fd2 = new FormData(form);
              fd2.delete('cv');
              res = await send(fd2);
            }
          }
        }

        if (res.ok) {
          alert('Submitted! Check your Formspree dashboard / email.');
          // Optional reset
          form.reset();
          document.getElementById('page2').classList.remove('active');
          document.getElementById('page1').classList.add('active');
          return;
        }

        // Show detailed error if available
        let msg = 'Could not submit. ';
        try {
          const data = await res.json();
          if (data && data.errors && data.errors.length) {
            msg += data.errors.map(e => e.message).join('; ');
          } else if (data && data.message) {
            msg += data.message;
          } else {
            msg += 'Check your Formspree form status and allowed fields.';
          }
        } catch (_) {
          msg += 'Check your Formspree form status and allowed fields.';
        }
        alert(msg);
      } catch (err) {
        console.error(err);
        alert('Network or CORS error. Make sure your Formspree form is active/verified.');
      }
    });
  </script>
</body>
</html>
